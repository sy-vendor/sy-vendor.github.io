<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********  Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>GraphQL api服务器 | sy-vendor-blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="sy-vendor-blog">
    <meta name="author" content="sy">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="sy-vendor-blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/C/" class="animsition-link">C<small>(1)</small></a></li>
				    
				    <li><a href="/categories/erlang/" class="animsition-link">erlang<small>(17)</small></a></li>
				    
				    <li><a href="/categories/go/" class="animsition-link">go<small>(20)</small></a></li>
				    
				    <li><a href="/categories/java/" class="animsition-link">java<small>(2)</small></a></li>
				    
				    <li><a href="/categories/other/" class="animsition-link">other<small>(12)</small></a></li>
				    
				</ul>
        	</li>
			
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">sy-vendor-blog</a></li>
                            <li class="nolink"><span>Always </span>Fighting.</li>
                            
                            <li><a href="https://github.com/sy-vendor" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2023-03-12T04:19:42.000Z" itemprop="datePublished">
          2023-03-12
      </time>
    
</span>
                <h1>GraphQL api服务器</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h4 id="选择-GraphQL-的好处？"><a href="#选择-GraphQL-的好处？" class="headerlink" title="选择 GraphQL 的好处？"></a>选择 GraphQL 的好处？</h4><ul>
<li>避免对 API 进行多个版本控制</li>
<li>客户端可以只获取其需要的字段，而服务端不用做特殊的处理</li>
<li>避免多次调用API以获取相关联数据。GraphQL允许了在单个请求中获取其相关联数据</li>
<li>提高其程序性能</li>
</ul>
<h4 id="GraphQL-架构"><a href="#GraphQL-架构" class="headerlink" title="GraphQL 架构"></a>GraphQL 架构</h4><p><img src="https://www.suyi1995.com/wp-content/uploads/2023/03/%E6%88%AA%E5%B1%8F2023-03-13-10.27.29-1024x531.png"></p>
<ol>
<li>Schema: 定义了数据的类型、数据之间的关系以及允许客户端进行的操作，以及每个操作的参数和返回类型。</li>
<li>Queries: 用于从GraphQL服务器检索数据。</li>
<li>Mutations: 用于对服务器进行写操作，比如新增、修改和删除等操作。</li>
</ol>
<h4 id="使用-golang-Gin-创建-GraphQL-api-服务器"><a href="#使用-golang-Gin-创建-GraphQL-api-服务器" class="headerlink" title="使用 golang Gin 创建 GraphQL api 服务器"></a>使用 golang Gin 创建 GraphQL api 服务器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;初始项目环境&#x27;</span><br><span class="line">$ mkdir graphql_test_server</span><br><span class="line">$ cd graphql_test_server</span><br><span class="line">$ go mod init github.com/sy-vendor/graphql_test_server</span><br><span class="line">$ go get github.com/99designs/gqlgen</span><br><span class="line">$ go get -u github.com/gin-gonic/gin</span><br><span class="line">$ go get -u github.com/jinzhu/gorm</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;构建服务器&#x27;</span><br><span class="line">$ go run github.com/99designs/gqlgen init</span><br></pre></td></tr></table></figure>

<h4 id="编写-GraphQL"><a href="#编写-GraphQL" class="headerlink" title="编写 GraphQL"></a>编写 GraphQL</h4><p>文件graph&#x2F;schema.graphqls</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">type Question&#123;</span><br><span class="line">  id: String!</span><br><span class="line">  question_text: String!</span><br><span class="line">  pub_date: String!</span><br><span class="line">  choices: [Choice]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Choice&#123;</span><br><span class="line">  id: String!</span><br><span class="line">  question: Question!</span><br><span class="line">  question_id: String!</span><br><span class="line">  choice_text: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query &#123;</span><br><span class="line">  questions: [Question]!</span><br><span class="line">  choices: [Choice]!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input QuestionInput &#123;</span><br><span class="line">  question_text: String!</span><br><span class="line">  pub_date: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input ChoiceInput &#123;</span><br><span class="line">  question_id: String!</span><br><span class="line">  choice_text: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Mutation &#123;</span><br><span class="line">  createQuestion(input: QuestionInput!): Question!</span><br><span class="line">  createChoice(input: ChoiceInput): Choice!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行下面的命令来更新schema实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rm graph/schema.resolvers.go &amp;&amp; gqlgen generate</span><br></pre></td></tr></table></figure>

<p>打开 graph&#x2F;schema.resolvers.go，查看是否像如下生成了<strong>查询</strong><code>func (r *queryResolver) Questions</code>和<code>func (r *queryResolver) Choices</code>以及<code>func (r *mutationResolver) CreateQuestion</code>。<code>func (r *mutationResolver) CreateChoice</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package graph</span><br><span class="line"></span><br><span class="line">// This file will be automatically regenerated based on the schema, any resolver implementations</span><br><span class="line">// will be copied through when generating and any unknown code will be moved to the end.</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">        &quot;context&quot;</span><br><span class="line">        &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">        &quot;github.com/sy-vendor/gin-graphql-postgres/graph/generated&quot;</span><br><span class="line">        &quot;github.com/sy-vendor/gin-graphql-postgres/graph/model&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func (r *mutationResolver) CreateQuestion(ctx context.Context, input model.QuestionInput) (*model.Question, error) &#123;</span><br><span class="line">        panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *mutationResolver) CreateChoice(ctx context.Context, input *model.ChoiceInput) (*model.Choice, error) &#123;</span><br><span class="line">        panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *queryResolver) Questions(ctx context.Context) ([]*model.Question, error) &#123;</span><br><span class="line">        panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *queryResolver) Choices(ctx context.Context) ([]*model.Choice, error) &#123;</span><br><span class="line">        panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Mutation returns generated.MutationResolver implementation.</span><br><span class="line">func (r *Resolver) Mutation() generated.MutationResolver &#123; return &amp;mutationResolver&#123;r&#125; &#125;</span><br><span class="line"></span><br><span class="line">// Query returns generated.QueryResolver implementation.</span><br><span class="line">func (r *Resolver) Query() generated.QueryResolver &#123; return &amp;queryResolver&#123;r&#125; &#125;</span><br><span class="line"></span><br><span class="line">type mutationResolver struct&#123; *Resolver &#125;</span><br><span class="line">type queryResolver struct&#123; *Resolver &#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用’gorm’设置数据库orm"><a href="#使用’gorm’设置数据库orm" class="headerlink" title="使用’gorm’设置数据库orm"></a>使用’gorm’设置数据库orm</h4><p>创建文件<code>db/main.go</code>并实现以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package database</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com/jinzhu/gorm&quot;</span><br><span class="line">_ &quot;github.com/jinzhu/gorm/dialects/postgres&quot;</span><br><span class="line"></span><br><span class="line">&quot;graphql_test_server/graph/model&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type dbConfig struct &#123;</span><br><span class="line">host     string</span><br><span class="line">port     int</span><br><span class="line">user     string</span><br><span class="line">dbname   string</span><br><span class="line">password string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var config = dbConfig&#123;&quot;localhost&quot;, 5432, &quot;postgres&quot;, &quot;test&quot;, &quot;root&quot;&#125;</span><br><span class="line"></span><br><span class="line">func getDatabaseUrl() string &#123;</span><br><span class="line">return fmt.Sprintf(</span><br><span class="line">&quot;host=%s port=%d user=%s dbname=%s password=%s&quot;,</span><br><span class="line">config.host, config.port, config.user, config.dbname, config.password)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func GetDatabase() (*gorm.DB, error) &#123;</span><br><span class="line">db, err := gorm.Open(&quot;postgres&quot;, getDatabaseUrl())</span><br><span class="line">return db, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func RunMigrations(db *gorm.DB) &#123;</span><br><span class="line">if !db.HasTable(&amp;model.Question&#123;&#125;) &#123;</span><br><span class="line">db.CreateTable(&amp;model.Question&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">if !db.HasTable(&amp;model.Choice&#123;&#125;) &#123;</span><br><span class="line">db.CreateTable(&amp;model.Choice&#123;&#125;)</span><br><span class="line">db.Model(&amp;model.Choice&#123;&#125;).AddForeignKey(&quot;question_id&quot;, &quot;questions(id)&quot;, &quot;CASCADE&quot;, &quot;CASCADE&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完善-GraphQL-解析器"><a href="#完善-GraphQL-解析器" class="headerlink" title="完善 GraphQL 解析器"></a>完善 GraphQL 解析器</h4><p>编写graph&#x2F;schema.resolvers.go</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">package graph</span><br><span class="line"></span><br><span class="line">// This file will be automatically regenerated based on the schema, any resolver implementations</span><br><span class="line">// will be copied through when generating and any unknown code will be moved to the end.</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;context&quot;</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;log&quot;</span><br><span class="line"></span><br><span class="line">database &quot;graphql_test_server/db&quot;</span><br><span class="line">&quot;graphql_test_server/graph/generated&quot;</span><br><span class="line">&quot;graphql_test_server/graph/model&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func (r *mutationResolver) CreateQuestion(ctx context.Context, input model.QuestionInput) (*model.Question, error) &#123;</span><br><span class="line">db, err := database.GetDatabase()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Println(&quot;Unable to connect to database&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line">defer db.Close()</span><br><span class="line">fmt.Println(&quot;input&quot;, input.QuestionText, input.PubDate)</span><br><span class="line">question := model.Question&#123;&#125;</span><br><span class="line">question.QuestionText = input.QuestionText</span><br><span class="line">question.PubDate = input.PubDate</span><br><span class="line">db.Create(&amp;question)</span><br><span class="line">return &amp;question, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *mutationResolver) CreateChoice(ctx context.Context, input *model.ChoiceInput) (*model.Choice, error) &#123;</span><br><span class="line">db, err := database.GetDatabase()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Println(&quot;Unable to connect to database&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line">defer db.Close()</span><br><span class="line">choice := model.Choice&#123;&#125;</span><br><span class="line">question := model.Question&#123;&#125;</span><br><span class="line">choice.QuestionID = input.QuestionID</span><br><span class="line">choice.ChoiceText = input.ChoiceText</span><br><span class="line">db.First(&amp;question, choice.QuestionID)</span><br><span class="line">choice.Question = &amp;question</span><br><span class="line">db.Create(&amp;choice)</span><br><span class="line">return &amp;choice, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *queryResolver) Questions(ctx context.Context) ([]*model.Question, error) &#123;</span><br><span class="line">db, err := database.GetDatabase()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Println(&quot;Unable to connect to database&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line">defer db.Close()</span><br><span class="line">db.Find(&amp;r.questions)</span><br><span class="line">for _, question := range r.questions &#123;</span><br><span class="line">var choices []*model.Choice</span><br><span class="line">db.Where(&amp;model.Choice&#123;QuestionID: question.ID&#125;).Find(&amp;choices)</span><br><span class="line">question.Choices = choices</span><br><span class="line">&#125;</span><br><span class="line">return r.questions, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *queryResolver) Choices(ctx context.Context) ([]*model.Choice, error) &#123;</span><br><span class="line">db, err := database.GetDatabase()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Println(&quot;Unable to connect to database&quot;, err)</span><br><span class="line">return nil, err</span><br><span class="line">&#125;</span><br><span class="line">defer db.Close()</span><br><span class="line">db.Find(&amp;r.choices)</span><br><span class="line">return r.choices, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Mutation returns generated.MutationResolver implementation.</span><br><span class="line">func (r *Resolver) Mutation() generated.MutationResolver &#123; return &amp;mutationResolver&#123;r&#125; &#125;</span><br><span class="line"></span><br><span class="line">// Query returns generated.QueryResolver implementation.</span><br><span class="line">func (r *Resolver) Query() generated.QueryResolver &#123; return &amp;queryResolver&#123;r&#125; &#125;</span><br><span class="line"></span><br><span class="line">type mutationResolver struct&#123; *Resolver &#125;</span><br><span class="line">type queryResolver struct&#123; *Resolver &#125;</span><br></pre></td></tr></table></figure>

<p>最后编写server.go</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span><br><span class="line">&quot;github.com/99designs/gqlgen/graphql/playground&quot;</span><br><span class="line">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="line"></span><br><span class="line">&quot;graphql_test_server/graph&quot;</span><br><span class="line">&quot;graphql_test_server/graph/generated&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const defaultPort = &quot;:8080&quot;</span><br><span class="line"></span><br><span class="line">// Defining the Graphql handler</span><br><span class="line">func graphqlHandler() gin.HandlerFunc &#123;</span><br><span class="line">// NewExecutableSchema and Config are in the generated.go file</span><br><span class="line">// Resolver is in the resolver.go file</span><br><span class="line">h := handler.NewDefaultServer(generated.NewExecutableSchema(generated.Config&#123;Resolvers: &amp;graph.Resolver&#123;&#125;&#125;))</span><br><span class="line"></span><br><span class="line">return func(c *gin.Context) &#123;</span><br><span class="line">h.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Defining the Playground handler</span><br><span class="line">func playgroundHandler() gin.HandlerFunc &#123;</span><br><span class="line">h := playground.Handler(&quot;GraphQL&quot;, &quot;/query&quot;)</span><br><span class="line"></span><br><span class="line">return func(c *gin.Context) &#123;</span><br><span class="line">h.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">r.POST(&quot;/query&quot;, graphqlHandler())</span><br><span class="line">r.GET(&quot;/&quot;, playgroundHandler())</span><br><span class="line">r.Run(defaultPort)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在使用如下命令准备测试 <em>GraphQL</em> api 服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go run server.go</span><br></pre></td></tr></table></figure>

<p><img src="https://www.suyi1995.com/wp-content/uploads/2023/03/%E6%88%AA%E5%B1%8F2023-03-13-12.10.20-1024x264.png"></p>
<h4 id="GraphQL-中-mutation"><a href="#GraphQL-中-mutation" class="headerlink" title="GraphQL 中 mutation"></a>GraphQL 中 mutation</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">  createQuestion(input: &#123;question_text: &quot;What is your name ?&quot;, pub_date: &quot;2023-03-12&quot;&#125;)&#123;</span><br><span class="line">    id</span><br><span class="line">    question_text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行上述查询后，将得到如下所示的 JSON 数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;createQuestion&quot;: &#123;</span><br><span class="line">      &quot;id&quot;: &quot;3&quot;,</span><br><span class="line">      &quot;question_text&quot;: &quot;What is your name ?&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面用数据创建<code>&#123;question_text: &quot;What is your name ?&quot;, pub_date: &quot;2020-04-27&quot;&#125;</code>，创建后要求它返回<code>id</code>, <code>question_text</code>。如果只想要 id 那么可以<code>question_text</code>从查询中删除。</p>
<p>相应的<code>cURL</code>请求如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://localhost:8080/query&#x27; \</span><br><span class="line">  -H &#x27;Connection: keep-alive&#x27; \</span><br><span class="line">  -H &#x27;accept: */*&#x27; \</span><br><span class="line">  -H &#x27;User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.113 Safari/537.36&#x27; \</span><br><span class="line">  -H &#x27;content-type: application/json&#x27; \</span><br><span class="line">  -H &#x27;Origin: http://localhost:8080&#x27; \</span><br><span class="line">  -H &#x27;Sec-Fetch-Site: same-origin&#x27; \</span><br><span class="line">  -H &#x27;Sec-Fetch-Mode: cors&#x27; \</span><br><span class="line">  -H &#x27;Sec-Fetch-Dest: empty&#x27; \</span><br><span class="line">  -H &#x27;Referer: http://localhost:8080/&#x27; \</span><br><span class="line">  -H &#x27;Accept-Language: en-GB,en-US;q=0.9,en;q=0.8&#x27;\</span><br><span class="line">  --data-binary &#x27;&#123;&quot;operationName&quot;:null,&quot;variables&quot;:&#123;&#125;,&quot;query&quot;:&quot;mutation &#123;\n  createQuestion(input: &#123;question_text: \&quot;What is your name ?\&quot;, pub_date: \&quot;2020-03-12\&quot;&#125;) &#123;\n    id\n    question_text\n  &#125;\n&#125;\n&quot;&#125;&#x27; \</span><br><span class="line">  --compressed</span><br></pre></td></tr></table></figure>

<p>同样方式创建<code>Choice</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">  createChoice(input: &#123;question_id: &quot;3&quot;, choice_text: &quot;Agiliq&quot;&#125;)&#123;</span><br><span class="line">    id</span><br><span class="line">    question&#123;</span><br><span class="line">      id</span><br><span class="line">      question_text</span><br><span class="line">    &#125;</span><br><span class="line">    choice_text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GraphQL-中-query"><a href="#GraphQL-中-query" class="headerlink" title="GraphQL 中 query"></a>GraphQL 中 <code>query</code></h4><p>编写一个 graphql 的query</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">query&#123;</span><br><span class="line">  questions&#123;</span><br><span class="line">    id</span><br><span class="line">    question_text</span><br><span class="line">    choices&#123;</span><br><span class="line">      id</span><br><span class="line">      choice_text</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按上述query条件请求将返回如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;questions&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;id&quot;: &quot;3&quot;,</span><br><span class="line">        &quot;question_text&quot;: &quot;What is your name ?&quot;,</span><br><span class="line">        &quot;choices&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;id&quot;: &quot;31&quot;,</span><br><span class="line">            &quot;choice_text&quot;: &quot;Agiliq&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码: <a target="_blank" rel="noopener" href="https://github.com/SuYi1995/graphql_test_server/"> Github - graphql_test_server</a></p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    
    <a class="pull-right" href="/2023/01/12/go-20230112/">
        Go 的 DI 库 google/wire →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By sy. All Rights Reserved.
                </p>
                <p>Theme By <a href="" style="color: #767D84">sy</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/sy-vendor" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
